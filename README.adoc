= CLARIN vlo image (`docker-vlo`)
:caution-caption: ☡ CAUTION
:important-caption: ❗ IMPORTANT
:note-caption: 🛈 NOTE
:sectanchors:
:sectlinks:
:sectnumlevels: 6
:sectnums:
:source-highlighter: pygments
:tip-caption: 💡 TIP
:toc-placement: preamble
:toc:
:warning-caption: ⚠ WARNING

== Dependencies

[options="header",cols=",,,m"]
|===
| Conditions | Type | Name (URL) | Version constraint

| by necessity
| software
| https://www.docker.com/[Docker Compose]
| ==1.8.0

| by necessity
| software
| https://www.docker.com/[Docker Engine]
| ==1.12.1

| by necessity
| image
| https://github.com/gliderlabs/docker-alpine[`gliderlabs/alpine`]
| ==3.4

| for Docker Engine interaction
| software
| https://www.sudo.ws/[Sudo]
| >=1.8

| for releases
| platform
| https://about.gitlab.[GitLab CI]
| ==8.10.4

|===

== To build and test

The build, test and release pipeline is specified in the the link:.gitlab-ci.yml[GitLab CI] config file.
This pipeline or its stages can be run by GitLab.com CI as well as by a self-hosted GitLab instance.
This is elaborated in the https://about.gitlab.com/gitlab-ci/[GitLab CI docs].
In addition, the build and test stages can be run be run locally within a bare Docker container, without a GitLab CI pipeline.

NOTE: Please issue all of the following shell statements from within the root directory of this repository.

=== Without a GitLab CI pipeline

[source,sh]
----
sh build.sh --local --build
----

=== Parameters

These are to be passed as environment variables. The `VloConfig.xml` file and other configuration files get filtered (i.e. placeholder substitution takes place) using these on container startup and/or import (see the `filter-vlo-config.sh`, `init.sh` and `importer.sh` scripts).

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_CONFIG_FILE
| Yes
| String
| `/opt/vlo/config/VloConfig.xml`
| Location (within container) of the VLO configuration file

| VLO_MAPPING_DEFINITIONS_DIST_URL
| No
| String
| `https://github.com/clarin-eric/VLO-mapping/archive/master.tar.gz`
| Specify the location of the tarball from which VLO mapping definitions are retrieved on startup and before import (leave empty to skip retrieval, e.g. when using a remote location - see `VLO_DOCKER_MAPPING_BASE_URI` parameter)

| VLO_MAPPING_DEFINITIONS_DIR
| Yes
| String
| `/srv/VLO-mapping`
| Path within container where VLO mapping files are read from and/or retrieved to

|===

Parameters that are used to filter VloConfig.xml:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_SOLR_URL
| Yes
| String
|
| base URL for the Solr instance to be used by the importer and web app for connecting.
- for example: `http://vlo_solr:8983/solr/vlo-index/` (trailing slash required!)

| VLO_DOCKER_PUBLIC_HOME_URL
| Yes
| String
| `http://localhost:8080`
| public base URL of the web application. 
- for example: `http://beta-vlo.clarin.eu`

| VLO_DOCKER_MAPPING_BASE_URI
| Yes
| String
| `file:/srv/VLO-mapping/`
| base URL (file or http) for retrieval of the VLO mapping files. 
- for example: `file:/srv/VLO-mapping/`eu`

| VLO_DOCKER_FILE_PROCESSING_THREADS
| Yes
| Integer
| `-1`
| number of file processing threads (number of CPU cores seems to be a good rule of thumb, or use -1 to let the VM decide based on the available number of cores)

| VLO_DOCKER_SOLR_THREADS
| Yes
| Integer
| `2`
| number of Solr threads (0.5 to 1.0 times the number of file processing threads seems to be a good rule of thumb)

| VLO_DOCKER_DELETE_ALL_FIRST
| Yes
| Boolean
| `false`
| a boolean determining whether the index should be cleaned at the start of import

| VLO_DOCKER_MAX_DAYS_IN_SOLR
| Yes
| Integer
| `7`
| number of days after which files that have disappeared should be removed from the index

| VLO_DOCKER_DATAROOTS_FILE
| Yes
| String
| `dataroots-production.xml`
| filename (absolute or relative to `VloConfig.xml`) that defines the data roots; this can be one of the shipped data root definitions or your own custom definition from a volume or mount
- for example: `dataroots-production.xml`
- or: `/srv/myconfig/dataroots.xml`

|===

https://github.com/etsy/statsd[StatsD] parameters - not setting one of these will prevent statistics from being collected and sent after import:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| STATSD_PREFIX
| No
| String
|
| specifiy an alternative statsd prefix when sending statistics
- for example: `vlo.beta`

| VLO_DOCKER_STATSD_HOST
| No
| String
|
| StatsD host to send metrics to
- for example: `stats.domain.com`

| VLO_DOCKER_STATSD_PORT
| No
| Port number
| `8125`
| StatsD port on host
- for example: `8125`

|===
https://www.piwik.org[Piwik] (access statistics gathering) parameters:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_PIWIK_ENABLE_TRACKER
| Yes
| Boolean
| `false`
| Whether Piwik tracking should be enabled

| VLO_DOCKER_PIWIK_HOST
| No
| Port number
| `https://stats.clarin.eu/`
| Piwik instance to report to

| VLO_DOCKER_PIWIK_SITE_ID
| No
| String
| 3
| Site ID to report for

| VLO_DOCKER_PIWIK_DOMAINS
| No
| Port number
| `*.vlo.clarin.eu`
| Domain(s) to report for

|===
