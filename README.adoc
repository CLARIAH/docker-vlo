= CLARIN vlo image (`docker-vlo`)
:caution-caption: ☡ CAUTION
:important-caption: ❗ IMPORTANT
:note-caption: 🛈 NOTE
:sectanchors:
:sectlinks:
:sectnumlevels: 6
:sectnums:
:source-highlighter: pygments
:tip-caption: 💡 TIP
:toc-placement: preamble
:toc:
:warning-caption: ⚠ WARNING

== Dependencies

[options="header",cols=",,,m"]
|===
| Conditions | Type | Name (URL) | Version constraint

| by necessity
| software
| https://www.docker.com/[Docker Compose]
| ==1.8.0

| by necessity
| software
| https://www.docker.com/[Docker Engine]
| ==1.12.1

| by necessity
| image
| https://github.com/gliderlabs/docker-alpine[`gliderlabs/alpine`]
| ==3.4

| for Docker Engine interaction
| software
| https://www.sudo.ws/[Sudo]
| >=1.8

| for releases
| platform
| https://about.gitlab.[GitLab CI]
| ==8.10.4

| for operation
| service
| https://lucene.apache.org/solr/[Apache Solr]
| >=7.0.0

|===

== To build and test

The build, test and release pipeline is specified in the the link:.gitlab-ci.yml[GitLab CI] config file.
This pipeline or its stages can be run by GitLab.com CI as well as by a self-hosted GitLab instance.
This is elaborated in the https://about.gitlab.com/gitlab-ci/[GitLab CI docs].
In addition, the build and test stages can be run be run locally within a bare Docker container, without a GitLab CI pipeline.

NOTE: Please issue all of the following shell statements from within the root directory of this repository.

=== Without a GitLab CI pipeline

[source,sh]
----
bash build.sh --local --build
----

==== Alternative data source

By default, the `copy_data.sh` reads a number of variables from the `copy_data.env.sh`
file, which defines the VLO version number and where to fetch it (remotely). You can
use an alternative file, for example to build on basis of your local development output.
Export the `DATA_ENV_FILE` variable to specify an alternative environment definitions
file.

For example:
[source,sh]
----
export DATA_ENV_FILE=copy_data_dev.env.sh
bash build.sh --local --build
----

== Upgrading to a newer VLO version

The `copy_data.sh` script retrieves a VLO distribution package from GitHub on basis of a
fixed URL scheme that takes the VLO version as a parameter. To make this work for a new
release of the VLO, make sure the following has taken place:

. The target version of the VLO has been tagged with a tag of the from `vlo-${VERSION}`,
and this tag has been pushed to GitHub
** for examples see the https://github.com/clarin-eric/VLO/tags[existing tags]
. A release has been made on basis of this tag 
** see
https://github.com/clarin-eric/VLO/releases)[existing releases] and the
https://help.github.com/articles/about-releases/[GitHub documentation on releases]
. A docker specific build of the VLO has been created (using `mvn package -Pdocker`) and
its distribution package (the output of the `vlo-distribution` subproject) has been
attached to the release
** this should result in there being a distribution package 
available (publicly) at the URL
`https://github.com/clarin-eric/VLO/releases/download/vlo-${VERSION}/vlo-${VERSION}-docker.tar.gz`
** see the https://github.com/clarin-eric/VLO/blob/master/README.md[VLO documentation] for
more information on building the VLO

Given these conditions, the only required change in this project is to set the 
`VLO_VERSION` variable in `copy_data.sh` to the target version.

== Parameters

These are to be passed as environment variables. The `VloConfig.xml` file and other configuration files get filtered (i.e. placeholder substitution takes place) using these on container startup and/or import (see the `filter-vlo-config.sh`, `init.sh` and `importer.sh` scripts).

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_CONFIG_FILE
| Yes
| String
| `/opt/vlo/config/VloConfig.xml`
| Location (within container) of the VLO configuration file

| VLO_MAPPING_DEFINITIONS_DIST_URL
| No
| String
| `https://github.com/clarin-eric/VLO-mapping/archive/master.tar.gz`
| Specify the location of the tarball from which VLO mapping definitions are retrieved on startup and before import (leave empty to skip retrieval, e.g. when using a remote location - see `VLO_DOCKER_MAPPING_BASE_URI` parameter)

| VLO_MAPPING_DEFINITIONS_DIR
| Yes
| String
| `/srv/VLO-mapping`
| Path within container where VLO mapping files are read from and/or retrieved to

|===

Parameters that are used to filter `VloConfig.xml`:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_SOLR_URL
| Yes
| String
|
| base URL for the Solr instance to be used by the importer and web app for connecting.
- for example: `http://vlo_solr:8983/solr/vlo-index/` (trailing slash required!)

| VLO_DOCKER_PUBLIC_HOME_URL
| Yes
| String
| `http://localhost:8080`
| public base URL of the web application. 
- for example: `http://beta-vlo.clarin.eu`

| VLO_DOCKER_MAPPING_BASE_URI
| Yes
| String
| `file:/srv/VLO-mapping/`
| base URL (file or http) for retrieval of the VLO mapping files

| VLO_DOCKER_FILE_PROCESSING_THREADS
| Yes
| Integer
| `-1`
| number of file processing threads (number of CPU cores seems to be a good rule of thumb, or use -1 to let the VM decide based on the available number of cores)

| VLO_DOCKER_SOLR_THREADS
| Yes
| Integer
| `2`
| number of Solr threads (0.5 to 1.0 times the number of file processing threads seems to be a good rule of thumb)

| VLO_DOCKER_DELETE_ALL_FIRST
| Yes
| Boolean
| `false`
| a boolean determining whether the index should be cleaned at the start of import

| VLO_DOCKER_MAX_DAYS_IN_SOLR
| Yes
| Integer
| `7`
| number of days after which files that have disappeared should be removed from the index

| VLO_DOCKER_DATAROOTS_FILE
| Yes
| String
| `dataroots-production.xml`
| filename (absolute or relative to `VloConfig.xml`) that defines the data roots; this can be one of the shipped data root definitions or your own custom definition from a volume or mount
- for example: `dataroots-production.xml`
- or: `/srv/myconfig/dataroots.xml`

|===

https://github.com/etsy/statsd[StatsD] parameters - not setting one of these will prevent statistics from being collected and sent after import:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| STATSD_PREFIX
| No
| String
|
| specifiy an alternative statsd prefix when sending statistics
- for example: `vlo.beta`

| VLO_DOCKER_STATSD_HOST
| No
| String
|
| StatsD host to send metrics to
- for example: `stats.domain.com`

| VLO_DOCKER_STATSD_PORT
| No
| Port number
| `8125`
| StatsD port on host
- for example: `8125`

|===
https://www.piwik.org[Piwik] (access statistics gathering) parameters:

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_PIWIK_ENABLE_TRACKER
| Yes
| Boolean
| `false`
| Whether Piwik tracking should be enabled

| VLO_DOCKER_PIWIK_HOST
| No
| Port number
| `https://stats.clarin.eu/`
| Piwik instance to report to

| VLO_DOCKER_PIWIK_SITE_ID
| No
| String
| 3
| Site ID to report for

| VLO_DOCKER_PIWIK_DOMAINS
| No
| Port number
| `*.vlo.clarin.eu`
| Domain(s) to report for

|===

User satisfaction score elicitation parameters (see https://github.com/clarin-eric/VLO/issues/165[VLO #165]):

[options="header",cols=",,,,"]
|===
| Name | Required | Type | Default value | Description

| VLO_DOCKER_RATING_ENABLED
| Yes
| Boolean
| `false`
| Whether user satisfaction ('rating panel') should be enabled; this requires a CouchDB backend to be available (see other parameters)

| VLO_DOCKER_RATING_SERVICE_NAME
| Yes
| String
| `VLO`
| Name of the service to store along with the ratings

| VLO_DOCKER_RATING_SHOW_PANEL_DELAY
| Yes
| Integer
| `120`
| Minimal time (seconds) to wait between session start and first appearance of panel

| VLO_DOCKER_RATING_DISMISS_TIMEOUT
| Yes
| Integer
| `604800`
| Minimal time (seconds) between dismissing the panel and showing it again

| VLO_DOCKER_RATING_SUBMIT_TIMEOUT
| Yes
| Integer
| `2592000`
| Minimal time (seconds) between submitting the panel and showing it again

| VLO_DOCKER_RATING_COUCHDB_URL
| Yes
| URL
| `http://couchdb:5984/ratings`
| URL of REST resource provided by CouchDB (or other compatible service) where the ratings should be submitted to

| VLO_DOCKER_RATING_COUCHDB_USER
| Yes
| String
| `vlo`
| CouchDB (or other compatible service) user name (leave empty for no auth)

| VLO_DOCKER_RATING_COUCHDB_PASSWORD
| Yes
| String
| `vlo`
| CouchDB (or other compatible service) password
	
|===
